---
layout: post
title: "How to add a new check in kube-linter? #31"
description: "rough notes of what things I did today"
category: upstream-contribution
tags: [kubernetes]
comments: false
---

Aug 17, 2021

The following document demonstrates the steps required to add a new validation check in the upstream [**kube-linter project**](https://github.com/stackrox/kube-linter).

> KubeLinter is a static analysis tool that checks Kubernetes YAML files and Helm charts to ensure the applications represented in them adhere to best practices. 

The document takes the static check [**`latest-tag`**](https://github.com/stackrox/kube-linter/tree/main/pkg/templates/latesttag) as an exmaple check to lay down the following steps!

---

#### **STEP 1:** Setup the project on your local machine

- Clone the project repository & change directory to the project root

  ```
  git clone git@github.com:stackrox/kube-linter.git
  
  cd kube-linter/
  ```

#### **STEP 2:** Change directory to pkg/templates folder & create a new directory with a name corresponding to the new check

- change directory to the `pkg/templates` folder from the root of the project

  ```
  cd pkg/templates
  ```

- make a new directory with the name of the new check (For example, [`latesttag`](https://github.com/stackrox/kube-linter/tree/main/pkg/templates/latesttag))

  ```
  mkdir latesttag
  ```

#### **STEP 3:** Under the new folder i.e `pkg/templates/latesttag`, implement the logic for the new check

- create the following files & folders in the path `pkg/templates/latesttag`, 
    - **internal/params/params.go**
          
      The [`internal/params/params.go`](https://github.com/stackrox/kube-linter/blob/main/pkg/templates/latesttag/internal/params/params.go) file will contain the paramaters required for the test check. 
      
    - **template.go**

       The actual implementation logic for the new test check will be written in the [`template.go`](https://github.com/stackrox/kube-linter/blob/main/pkg/templates/latesttag/template.go) file.
       
    - **template_test.go**
       
      And finally, the unit tests to validate the new check logic will be written in [`template_test.go`](https://github.com/stackrox/kube-linter/blob/main/pkg/templates/latesttag/template_test.go) file


#### **STEP 4:** Once the test logic (& it's unit tests), all are in place, include the check in kube-linter

- From the root of the project, modify the [`pkg/templates/all/all.go`](https://github.com/stackrox/kube-linter/blob/main/pkg/templates/all/all.go) file to include the path to our new test, i.e. `pkg/templates/latesttag`

  ```
  vim pkg/templates/all/all.go
  ```
  
  And modify the file to look like following:
  
  ```go
  package all

  import (
    // Import all check templates.
    ...
    _ "golang.stackrox.io/kube-linter/pkg/templates/latesttag"
    ...
  )

  ```

#### **STEP 5:** Include the new check as a kube-linter builtin check

- From the root of the project, go to the `pkg/builtin-checks/yamls` folder & make a new yaml file corresponding to the name of the new check, like [`latest-tag.yaml`](https://github.com/stackrox/kube-linter/blob/main/pkg/builtinchecks/yamls/latest-tag.yaml).

  ```
  vim latest-tag.yaml
  ```
  And edit the file to look like following:
  
  ```yaml
  name: "latest-tag"
  description: "Indicates when a deployment-like object is running a container with an invalid container image"
  remediation: "Use a container image with a proper image tag satisfying the \"AllowList\" & \"BlockList\" regex patterns."
  scope:
    objectKinds:
      - DeploymentLike
  template: "latest-tag"
  params:
    BlockList: [".*:(latest)$"]
    AllowList: []
  ```

- The `latest-tag.yaml` file does the following:
    
    - `name`, `description` & `remediation` takes self-explanatory string values.
    - define the scope of the check, using the following block

    ```yaml
    scope:
      objectKinds:
        - DeploymentLike
    ```
    
    - references the new test check template (defined at `pkg/templates/latesttag/template.go`) using a yaml field giving it a value equal to name of the check, for eg. `template: "latest-tag"`
    - provides default paramaeter values required by the check validation logic (defined at `pkg/templates/latesttag/internal/params/params.go`

    ```yaml
    params:
      BlockList: [".*:(latest)$"]
      AllowList: []
    ```
  
#### **(Optional) STEP 6:** Include the new check as a kube-linter default built-in check


So far, the new check is just a **builtin check**, but it is not a **default check** yet (i.e. kube-linter won't run this check by default unless specifically specified)

- In order to add the new check as a kube-linter default check:

  Edit the [`internal/defaultchecks/defaultcheck.go`](https://github.com/stackrox/kube-linter/blob/main/internal/defaultchecks/default_checks.go) file & add the new check name to look like the following:
  
  ```go
  package defaultchecks

  import (
    "golang.stackrox.io/kube-linter/internal/set"
  )

  var (
    // List is the list of built-in checks that are enabled by default.
    List = set.NewFrozenStringSet(
      ...
      "latest-tag",
      ...
    )
  )
  ```

Once everything above is done, the next step is to test the the new check!

#### **STEP 7:** Build the kube-linter binary from the local project. It'll contain the new check this time.

- Run the following command:
  
  ```
  make generated-srcs
  ```
  
  And the output would look something like:
  
  ```
  ‚ùØ make generated-srcs 
  go generate ./...
  Compiling Go source in ./cmd/kube-linter to bin/darwin/kube-linter
  Compiling Go source in ./cmd/kube-linter to bin/linux/kube-linter
  Compiling Go source in ./cmd/kube-linter to bin/windows/kube-linter.exe
  kube-linter templates list --format markdown > docs/generated/templates.md
  kube-linter checks list --format markdown > docs/generated/checks.md
  ```

 The above command generate local kube-linter binary, along with all the auto-generated check templates & markdown documentation required by the kube-linter command line binary tooling.
 
#### **STEP 8:** Test the new check with an example static yaml manifest

As the new check we're adding as part of this documentation, is for a `DeploymentLike` object scope, I'm creating an example deployment manifest yaml to do the testing.

- At the root of the project, create an `examples` directory & put a `deployment.yaml` under it (as our test deployment yaml manifest):

  ```
  mkdir examples
  
  cd examples/
  
  vim deployment.yaml
  ```
  
  Edit the `deployment.yaml` file to look like the following:

  ```yaml
  apiVersion: apps/v1
  kind: Deployment
  metadata:
    name: nginx-deployment
    labels:
      app: nginx
  spec:
    replicas: 2
    selector:
      matchLabels:
        app: nginx
    template:
      metadata:
        labels:
          app: nginx
      spec:
        containers:
        - name: nginx
          image: example.com/test:v1.0.0
          ports:
          - containerPort: 80
        - name: frontend
          image: quay.io/django:latest
          ports:
          - containerPort: 8000
        - name: key-value-store
          image: docker.io/redis:v1.4.1
          ports:
          - containerPort: 6379
  ```

  Finally, run the following to run all the kube-linter check on our test `deployment.yaml` manifest
  
  ```
  /bin/linux/kube-linter lint examples/deployment.yaml
  ```
  
  In case, you want to run just the `latest-tag` new check, do the following:

  ```
  /bin/linux/kube-linter lint --do-not-include-builtin-checks --include latest-tag examples/deployment.yaml
  ```
  
  And the output would look something like:
  
  ```
  ‚ùØ ./bin/linux/kube-linter lint /examples/deployment.yaml 
  KubeLinter 0.2.2-6-gc65dd74013-dirty

  examples/deployment.yaml: (object: <no namespace>/nginx-deployment apps/v1, Kind=Deployment) The container "nginx" is using an invalid container image, "example.com/test:v1.0.0". Please use images that satisfies the `AllowList` criteria : ["^(docker.io)"] (check: latest-tag, remediation: Use a container image with a proper image tag satisfying the "AllowList" & "BlockList" regex patterns.)

  examples/deployment.yaml: (object: <no namespace>/nginx-deployment apps/v1, Kind=Deployment) The container "frontend" is using an invalid container image, "quay.io/django:latest". Please use images that are not blocked by the `BlockList` criteria : [".*:(latest)$"] (check: latest-tag, remediation: Use a container image with a proper image tag satisfying the "AllowList" & "BlockList" regex patterns.)
  ...
  ```
  
   
#### **STEP 9:** Verify the unit tests & the E2E (end-to-end) tests

- Run the following command from the root of the project

  ```
  make test
  
  make e2e-test
  ```

#### **STEP 10:** Lint the project

- Run the following command from the root of the project to lint the project source code

  ```
  make lint
  ```

---

And finally, if you're happy with the new check, then raise a PR for the upstream `kube-linter` project & wait for a review! üôÇ
